# 增强版IDE开发工作流程

这是一个简单的逐步指南，帮助您使用BMad方法高效管理开发流程。该工作流程在整个开发生命周期中集成了测试架构师（QA代理），以确保质量、防止回归并保持高标准。如未涵盖的场景，请参考**[用户指南](user-guide.md)**。

## 创建新分支

1. **启动新分支**

## 故事创建（Scrum大师）

1. **开始新聊天/对话**
2. **加载SM代理**
3. **执行**：`*draft`（运行创建下一故事任务）
4. **在`docs/stories/`中审查生成的故事**
5. **更新状态**：从“草稿”变为“已批准”

## 故事实现（开发者）

1. **开始新聊天/对话**
2. **加载开发代理**
3. **执行**：`*develop-story {selected-story}`（运行执行检查清单任务）
4. **在`{selected-story}`中审查生成的报告**

## 测试架构师在整个工作流程中的集成

测试架构师（Quinn）在整个开发生命周期中提供全面的质量保证。以下是如何在适当的时机利用每个能力。

**命令别名：**文档中使用简写（`*risk`，`*design`，`*nfr`，`*trace`）代表完整命令（`*risk-profile`，`*test-design`，`*nfr-assess`，`*trace-requirements`）。

### 快速命令参考

| **阶段** | **命令** | **目的** | **输出** | **优先级** |
| --- | --- | --- | --- | --- |
| **故事批准后** | `*risk` | 识别集成与回归风险 | `docs/qa/assessments/{epic}.{story}-risk-{YYYYMMDD}.md` | 对复杂/旧项目为高 |
|  | `*design` | 为开发创建测试策略 | `docs/qa/assessments/{epic}.{story}-test-design-{YYYYMMDD}.md` | 对新功能为高 |
| **开发中** | `*trace` | 验证测试覆盖率 | `docs/qa/assessments/{epic}.{story}-trace-{YYYYMMDD}.md` | 中等 |
|  | `*nfr` | 验证质量属性 | `docs/qa/assessments/{epic}.{story}-nfr-{YYYYMMDD}.md` | 对关键特性为高 |
| **开发后** | `*review` | 全面评估 | QA结果在故事中 + `docs/qa/gates/{epic}.{story}-{slug}.yml` | **必需** |
| **评审后** | `*gate` | 更新质量决策 | 更新后的`docs/qa/gates/{epic}.{story}-{slug}.yml` | 根据需要 |

### 阶段1：故事创建后（开发开始前）

**推荐 - 为开发者成功打下基础：**

```bash
# 1. 风险评估（对于复杂故事优先运行）
@qa *risk {approved-story}
# 识别：
#   - 技术债务影响
#   - 集成复杂度
#   - 回归潜在（1-9评分）
#   - 缓解策略
# 关键：旧项目、API变更、数据迁移

# 2. 测试设计（第二步指导实现）
@qa *design {approved-story}
# 提供：
#   - 每个接受标准的测试场景
#   - 测试级别建议（单元/集成/E2E）
#   - 基于风险的优先级（P0/P1/P2）
#   - 测试数据需求
# 与开发分享：包括在故事评论中或附加到工单
```

### 阶段2：开发中（中途检查点）

**开发者自助质量检查：**

```bash
# 3. 需求追踪（验证中期覆盖）
@qa *trace {story-in-progress}
# 验证：
#   - 所有接受标准都有测试
#   - 无遗漏测试场景
#   - 适当的测试级别
#   - Given-When-Then文档清晰
# 运行时机：编写初始测试后

# 4. NFR验证（检查质量属性）
@qa *nfr {story-in-progress}
# 评估：
#   - 安全：认证、授权、数据保护
#   - 性能：响应时间、资源使用
#   - 可靠性：错误处理、恢复
#   - 可维护性：代码质量、文档
# 运行时机：标记“准备评审”前
```

### 阶段3：故事评审（质量关卡评估）

**必需 - 全面测试架构审查：**

**前提条件：**所有测试在本地通过；代码风格和类型检查通过。

```bash
# 5. 全面评审（标准评审流程）
@qa *review {已完成的故事}
```

**评审过程中发生的事情：**

1. **深入代码分析**
   - 架构模式符合性
   - 代码质量与可维护性
   - 安全漏洞扫描
   - 性能瓶颈检测

2. **主动重构**
   - 在安全情况下直接优化代码
   - 立即修复明显问题
   - 建议复杂重构给开发

3. **测试验证**
   - 各级覆盖（单元/集成/E2E）
   - 测试质量（无不稳定测试、正确断言）
   - 回归测试充分性

4. **关卡决策**
   - 创建：`docs/qa/gates/{epic}.{story}-{slug}.yml`
   - 添加：QA结果到故事文件
   - 状态：通过/关注点/不通过/豁免

### 阶段4：评审后（解决问题后）

**更新关卡状态：**

```bash
# 6. 关卡更新（记录最终决定）
@qa *gate {已评审故事}
# 更新：质量关卡状态
# 何时使用：处理完评审反馈后
# 记录：修复了什么、豁免了什么
```

### 理解关卡决策

| **状态** | **含义** | **所需行动** | **是否可以继续？** |
| --- | --- | --- | --- |
| **PASS** | 所有关键需求满足 | 无需操作 | ✅ 可以 |
| **CONCERNS** | 发现非关键问题 | 推荐团队评审 | ⚠️ 小心操作 |
| **FAIL** | 关键问题（安全、缺少P0测试） | 必须修复 | ❌ 不可 |
| **WAIVED** | 问题已确认并接受 | 记录理由 | ✅ 经批准 |

### 基于风险的测试策略

测试架构师利用风险评分优先安排测试：

| **风险评分** | **计算方式** | **测试优先级** | **关卡影响** |
| --- | --- | --- | --- |
| **9** | 高概率 × 高影响 | P0 - 必须彻底测试 | 未测试则失败 |
| **6** | 中高组合 | P1 - 应充分测试 | 存在缺口即关注 |
| **4** | 中等组合 | P1 - 应测试 | 存在明显缺口即关注 |
| **2-3** | 低中组合 | P2 - 可以有 | 在评审中备注 |
| **1** | 最小风险 | P2 - 最少 | 在评审中备注 |

### 特殊情况与最佳实践

#### 高风险或旧项目故事

```bash
# 始终运行此序列：
@qa *risk {story}    # 首先 - 识别风险
@qa *design {story}  # 第二 - 制定策略
# 开发中：
@qa *trace {story}   # 验证回归覆盖
@qa *nfr {story}     # 检查性能影响
# 最后：
@qa *review {story}  # 深入集成分析
```

#### 复杂集成

- 在开发中多次运行`*trace`
- 关注集成测试覆盖
- 使用`*nfr`验证跨系统性能
- 重点审查API契约

#### 性能关键特性

- 早期频繁运行`*nfr`（不仅仅在评审时）
- 在更改前建立性能基线
- 记录可接受的性能下降
- 在`*design`中考虑负载测试需求

### 强制执行的测试质量标准

Quinn确保所有测试符合以下标准：

- **无不稳定测试**：正确处理异步、显式等待
- **无硬等待**：仅动态策略（轮询、事件）
- **无状态**：测试独立并可并行
- **自我清理**：测试管理自己的测试数据
- **适当级别**：逻辑用单元，交互用集成，旅程用端到端
- **断言清晰**：断言在测试中，而非隐藏在辅助函数中

### 文档与审计追踪

所有测试架构师活动都创建永久记录：

- **评估报告**：时间戳分析存放于`docs/qa/assessments/`
- **关卡文件**：决策记录存放于`docs/qa/gates/`
- **故事更新**：在故事文件中添加QA结果部分
- **可追溯性**：需求到测试的映射持续维护

## 提交更改并推送

1. **提交更改**
2. **推送到远程**

## 完整的开发周期流程

### 全流程结合测试架构师

1. **SM**：创建下一个故事 → 审查 → 批准
2. **QA（可选）**：风险评估（`*risk`）→测试设计（`*design`）
3. **开发**：实现故事 → 编写测试 → 完成
4. **QA（可选）**：中期检查（`*trace`，`*nfr`）
5. **开发**：标记为“准备评审”
6. **QA（必需）**：评审故事（`*review`）→关卡决策
7. **开发（如需）**：解决问题
8. **QA（如需）**：更新关卡（`*gate`）
9. **提交**：所有更改
10. **推送**：到远程
11. **持续**：直到所有功能实现完毕

### 快速决策指南

**我是否应运行测试架构师命令？**

| **场景** | **开发前** | **开发中** | **开发后** |
| --- | --- | --- | --- |
| **简单Bug修复** | 可选 | 可选 | 必须`*review` |
| **新功能** | 推荐`*risk`、`*design` | 可选`*trace` | 必须`*review` |
| **旧项目变更** | **必需**`*risk`、`*design` | 推荐`*trace`、`*nfr` | 必须`*review` |
| **API修改** | **必需**`*risk`、`*design` | **必需**`*trace` | 必须`*review` |
| **性能关键** | 推荐`*design` | **必需**`*nfr` | 必须`*review` |
| **数据迁移** | **必需**`*risk`、`*design` | **必需**`*trace` | 必须`*review` + `*gate` |

### 成功指标

测试架构师帮助实现：

- 生产中零回归缺陷
- 需求覆盖率100%的测试
- 清晰的质量关卡，支持决定是否上线
- 技术债务的风险接受记录
- 团队内一致的测试质量
- 提早发现风险的左移测试
